<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quiz App</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
      }
      .question {
        margin-bottom: 15px;
      }
      .correct {
        color: green;
      }
      .incorrect {
        color: red;
      }
    </style>
  </head>
  <body class="container">
    <div class="d-flex justify-content-between align-items-center">
      <h2 class="text-center mb-0">Quiz App</h2>
      <a href="history.html" class="btn btn-secondary">History</a>
    </div>

    <div id="quiz-container" class="mt-3"></div>
    <button
      id="submit-btn"
      class="btn btn-primary mt-3"
      onclick="submitAnswers()"
      style="display: none"
    >
      Submit Answers
    </button>

    <script>
      const letters = ["A", "B", "C", "D"];
      let questions = [];
      let answers = {};
      const storageKey = "quizHistory";

      async function loadQuestions() {
        const response = await fetch(`./questions.json`);
        const data = await response.json();
        let loadedQuestions = [];

        for (const category in data) {
          const shuffled = data[category]
            .sort(() => 0.5 - Math.random()) // shuffle
            .slice(0, 1) // number of questions per category
            .map((q) => ({ ...q, category: category })); // add category to data
          loadedQuestions = [...loadedQuestions, ...shuffled];
        }

        questions = loadedQuestions.sort(() => 0.5 - Math.random());
        renderQuestions();
      }

      function renderQuestions() {
        const container = document.getElementById("quiz-container");
        container.innerHTML = "";

        questions.forEach((q, index) => {
          const div = document.createElement("div");
          div.className = "question border p-3 mb-3 rounded";
          div.innerHTML = `<p><strong>${q.question}</strong></p>`;

          for (const [key, value] of Object.entries(q.options)) {
            div.innerHTML += `
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="question-${q.id}" value="${key}" onchange="saveAnswer(${q.id}, '${key}')">
                            <label class="form-check-label">
                                ${letters[key]}: ${value}
                            </label>
                        </div>
                    `;
          }

          container.appendChild(div);
        });
        document.getElementById("submit-btn").style.display = "block";
      }

      function saveAnswer(questionId, choice) {
        console.log(questionId, choice);
        answers[questionId] = choice;
      }

      function submitAnswers() {
        let history = JSON.parse(localStorage.getItem(storageKey)) || [];

        const attempt = {
          timestamp: new Date().toISOString(),
          answers: answers,
        };

        history.push(attempt);
        localStorage.setItem(storageKey, JSON.stringify(history));
        window.location.href = `attempt.html?index=${history.length - 1}`;
      }

      window.onload = loadQuestions;
    </script>
  </body>
</html>
