<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quiz App</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
      }
      .question {
        margin-bottom: 15px;
      }
      .correct {
        color: green;
      }
      .incorrect {
        color: red;
      }
    </style>
  </head>
  <body class="container">
    <h2 class="text-center">Quiz App</h2>
    <p id="score" class="fw-bold text-center"></p>
    <div id="quiz-container" class="mt-3"></div>
    <button
      id="submit-btn"
      class="btn btn-primary mt-3"
      onclick="submitAnswers()"
      style="display: none"
    >
      Submit Answers
    </button>
    <a href="history.html" class="btn btn-secondary mt-3">View History</a>

    <script>
      let questions = [];
      let answers = {};
      const storageKey = "quizHistory";

      async function loadQuestions() {
        const files = ["anatomy.json", "physics.json", "procedures.json"]; // Add JSON files here
        let loadedQuestions = [];

        for (const file of files) {
          const response = await fetch(`./${file}`);
          const data = await response.json();
          const shuffled = data.sort(() => 0.5 - Math.random()).slice(0, 5);
          loadedQuestions = [...loadedQuestions, ...shuffled];
        }

        questions = loadedQuestions.sort(() => 0.5 - Math.random());
        renderQuestions();
      }

      function renderQuestions() {
        const container = document.getElementById("quiz-container");
        container.innerHTML = "";

        questions.forEach((q, index) => {
          const div = document.createElement("div");
          div.className = "question border p-3 mb-3 rounded";
          div.innerHTML = `<p><strong>${q.question_text}</strong></p>`;

          for (const [key, value] of Object.entries(q.options)) {
            div.innerHTML += `
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="question-${q.question_number}" value="${key}" onchange="saveAnswer(${q.question_number}, '${key}')"> 
                            <label class="form-check-label">
                                ${key}: ${value}
                            </label>
                        </div>
                    `;
          }

          container.appendChild(div);
        });
        document.getElementById("submit-btn").style.display = "block";
      }

      function saveAnswer(questionNumber, choice) {
        answers[questionNumber] = choice;
      }

      function submitAnswers() {
        let score = 0;
        let history = JSON.parse(localStorage.getItem(storageKey)) || [];

        document.querySelectorAll(".question").forEach((div, index) => {
          const q = questions[index];
          const userAnswer = answers[q.question_number] || "No answer";
          const correct = userAnswer === q.correct_answer;

          if (correct) {
            score++;
          }
          div.innerHTML += `<p class="${
            correct ? "text-success" : "text-danger"
          }">Your Answer: ${userAnswer} | Correct Answer: ${
            q.correct_answer
          }</p>`;
        });

        const scorePercentage = (score / questions.length) * 100;
        const scoreElement = document.getElementById("score");
        scoreElement.innerText = `Score: ${score} / ${
          questions.length
        } (${scorePercentage.toFixed(2)}%)`;
        scoreElement.className = `fw-bold text-center ${
          scorePercentage >= 75 ? "text-success" : "text-danger"
        }`;

        history.push({
          timestamp: new Date().toISOString(),
          score: scorePercentage,
          questions,
          answers,
        });
        localStorage.setItem(storageKey, JSON.stringify(history));
        document.getElementById("submit-btn").style.display = "none";
      }

      window.onload = loadQuestions;
    </script>
  </body>
</html>
