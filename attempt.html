<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quiz Attempt</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
      }
      .correct {
        color: green;
      }
      .incorrect {
        color: red;
      }
    </style>
  </head>
  <body class="container">
    <h2 class="text-center">Quiz Attempt</h2>
    <p id="attempt-info" class="fw-bold text-center"></p>
    <div id="score-breakdown" class="mt-3 text-center"></div>
    <div id="attempt-container" class="mt-3"></div>
    <a href="history.html" class="btn btn-secondary mt-3">Back to History</a>

    <script>
      const urlParams = new URLSearchParams(window.location.search);
      const attemptIndex = urlParams.get("index");
      const storageKey = "quizHistory";
      const history = JSON.parse(localStorage.getItem(storageKey)) || [];

      if (attemptIndex === null || attemptIndex >= history.length) {
        document.getElementById("attempt-container").innerHTML =
          "<p class='text-danger'>Invalid attempt.</p>";
      } else {
        const attempt = history[attemptIndex];
        document.getElementById("attempt-info").innerText = `Attempt ${
          parseInt(attemptIndex) + 1
        } - Score: ${attempt.score.toFixed(2)}% (${new Date(
          attempt.timestamp
        ).toLocaleString()})`;

        const scoreBreakdown = {
          anatomy: { correct: 0, total: 0 },
          physics: { correct: 0, total: 0 },
          procedure: { correct: 0, total: 0 },
        };

        const container = document.getElementById("attempt-container");
        attempt.questions.forEach((q, index) => {
          const div = document.createElement("div");
          div.className = "question border p-3 mb-3 rounded";
          div.innerHTML = `<p><strong>${q.question_text}</strong></p>`;

          for (const [key, value] of Object.entries(q.options)) {
            const isUserAnswer = attempt.answers[q.question_number] === key;
            const isCorrect = q.correct_answer === key;
            div.innerHTML += `
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="question-${
                              q.question_number
                            }" value="${key}" disabled ${
              isUserAnswer ? "checked" : ""
            }>
                            <label class="form-check-label ${
                              isCorrect
                                ? "correct"
                                : isUserAnswer
                                ? "incorrect"
                                : ""
                            }">
                                ${key}: ${value}
                            </label>
                        </div>
                    `;
          }

          div.innerHTML += `<p class="fw-bold ${
            attempt.answers[q.question_number] === q.correct_answer
              ? "text-success"
              : "text-danger"
          }">Your Answer: ${
            attempt.answers[q.question_number] || "No answer"
          } | Correct Answer: ${q.correct_answer}</p>`;
          container.appendChild(div);

          // Update score breakdown
          const category = q.source || "unknown";
          if (scoreBreakdown[category]) {
            scoreBreakdown[category].total++;
            if (attempt.answers[q.question_number] === q.correct_answer) {
              scoreBreakdown[category].correct++;
            }
          }
        });

        // Render score breakdown
        const breakdownContainer = document.getElementById("score-breakdown");
        breakdownContainer.innerHTML = `<h4>Score Breakdown</h4>`;
        for (const [category, data] of Object.entries(scoreBreakdown)) {
          const percentage =
            data.total > 0 ? (data.correct / data.total) * 100 : 0;
          breakdownContainer.innerHTML += `<p>${
            category.charAt(0).toUpperCase() + category.slice(1)
          }: ${data.correct} / ${data.total} (${percentage.toFixed(2)}%)</p>`;
        }
      }
    </script>
  </body>
</html>
